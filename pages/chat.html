<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TripBuilder ¬∑ Chat</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; }
    
    .navbar {
      background: #111827;
      color: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand {
      font-size: 20px;
      font-weight: bold;
      margin-right: auto;
    }
    .navbar-link {
      color: #9ca3af;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 14px;
    }
    .navbar-link:hover {
      color: white;
      background: rgba(255, 255, 255, 0.1);
    }
    .navbar-link.active {
      color: white;
      background: rgba(255, 255, 255, 0.2);
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .chat { 
      border:1px solid #e5e7eb; 
      border-radius:12px; 
      padding:12px; 
      max-height: 500px; 
      overflow-y: auto; 
      background: #fafafa;
    }
    
    /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
    .chat::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .chat::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    
    .chat::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    .msg { padding:10px 12px; border-radius:10px; margin:8px 0; max-width: 80%; }
    .user { background:#eef2ff; margin-left:auto; }
    .bot { background:#f3f4f6; }
    .row { display:flex; gap:10px; margin-top:12px; }
    input, button { font: inherit; }
    input[type="text"] { flex:1; border:1px solid #d1d5db; border-radius:8px; padding:8px; }
    button { border:1px solid #d1d5db; background:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
  </style>
</head>
<body>
  <!-- ÂØºËà™Ê†è -->
  <nav class="navbar">
    <div class="navbar-brand">üó∫Ô∏è TripBuilder</div>
    <a href="/builder" class="navbar-link">üìù Builder</a>
    <a href="/chat" class="navbar-link active">üí¨ Chat</a>
  </nav>

  <div class="container">
    <div id="chat" class="chat"></div>
    <div class="row">
      <input id="inp" type="text" placeholder="Ask for next destination..." />
      <button id="send" class="primary">Send</button>
    </div>
  </div>

<script>
const chat = document.getElementById('chat');
const inp = document.getElementById('inp');
const send = document.getElementById('send');

function push(role, text){
  const div = document.createElement('div');
  div.className = 'msg ' + (role==='user'?'user':'bot');
  

  if (role === 'assistant' && text.includes('**') && text.includes('+')) {
    div.innerHTML = text
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/^\+ /gm, '<br>‚Ä¢ ')
      .replace(/\n/g, '<br>');
  } else {
    div.textContent = text;
  }
  
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function loadChatHistory() {
  try {
    const res = await fetch('/api/chat/messages');
    const data = await res.json();
    
    chat.innerHTML = '';
    
    if (data.messages && data.messages.length > 0) {
      data.messages.forEach(msg => {
        push(msg.role, msg.content);
      });
    }
  } catch (error) {
    console.error('Failed to load chat history:', error);
  }
}

send.onclick = async () => {
  const q = inp.value.trim(); if(!q) return;
  push('user', q);
  inp.value = '';
  
  try {
    const res = await fetch('/api/reco/next-destination', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ user_message: q })
    });
    const data = await res.json();
    push('assistant', data.text || JSON.stringify(data));
  } catch (error) {
    console.error('Failed to send message:', error);
    push('assistant', 'Sorry, there was an error processing your request.');
  }
};

document.addEventListener('DOMContentLoaded', loadChatHistory);

inp.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    send.onclick();
  }
});
</script>
</body>
</html>
